name: Android CI

# manual only: doesn't work, must be on master branch or something
# on: workflow_dispatch

# on any push to specific branches:
on:
  push:
    branches: [ "tunnelmode" ]
  pull_request:
    branches: [ "tunnelmode" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:

    - name: decode keystore file from base64 secret to a jks file
      env:
            ENCODED_STRING: ${{ secrets.KEYSTORE }}
      run: |
            TMP_KEYSTORE_FILE_PATH="${RUNNER_TEMP}"/keystore
            mkdir "${TMP_KEYSTORE_FILE_PATH}"
            echo $ENCODED_STRING | base64 -di > "${TMP_KEYSTORE_FILE_PATH}"/apk-signing-key01.jks
            KEYSTOREFILE="${TMP_KEYSTORE_FILE_PATH}"/apk-signing-key01.jks
            echo $KEYSTOREFILE
            #export KEYSTOREFILE
            echo "KEYSTOREFILE=$KEYSTOREFILE" >> $GITHUB_ENV
    
    - name: checkout current repo code
      uses: actions/checkout@v3
    
    - name: Checkout submodules
      run: git submodule update --init --recursive

    - name: set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
        
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1.4.2
      with:
        ndk-version: r26b
        add-to-path: true
        local-cache: true

    - name: setup gradle current
      uses: gradle/gradle-build-action@v2
      id: setup-gradle
      with:
        gradle-version: current
        cache-read-only: false

    - name: create apk with gradle
      run: gradle :app:assembleNonRootRelease -Pandroid.injected.signing.store.file=${{env.KEYSTOREFILE}} -Pandroid.injected.signing.store.password=${{secrets.SIGNING_STORE_PASSWORD}} -Pandroid.injected.signing.key.alias=${{secrets.SIGNING_KEY_ALIAS}} -Pandroid.injected.signing.key.password=${{secrets.SIGNING_KEY_PASSWORD}}
      
    #- name: list app folder, all files -a, list -l, and recursively -R
    #  run: ls app -laR

    - name: Upload
      uses: actions/upload-artifact@v4.0.0
      with:
        name: Build Artifacts
        path: app/build/outputs/apk/nonRoot/release/app-nonRoot-release.apk
  
    - name: Upload to Release Action
      # You may pin to the exact commit or the version.
      # uses: Shopify/upload-to-release@c77c9b3e5d288adaef98a7007bf92340ec6ce03b
      uses: Shopify/upload-to-release@v2.0.0
      with:
        # Artifact name
        name: moonlight-android-ci-apk
        # Path to the file to upload
        path: app/build/outputs/apk/nonRoot/release/app-nonRoot-release.apk
        # Content type for the file
        # optional, default is application/octet-stream
        content-type: application/octet-stream
        repo-token: secrets.GITHUB_TOKEN
